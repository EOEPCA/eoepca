---
- hosts: localhost
  gather_facts: false
  become: no
  tasks:
    - name: "Check ansible version >=2.7.8"
      assert:
        msg: "Ansible must be v2.7.8 or higher"
        that:
          - ansible_version.string is version("2.7.8", ">=")
      tags:
        - check
  vars:
    ansible_connection: local

- hosts: bastion
  gather_facts: False
  vars:
    docker_email : ((asasd))
    docker_username: ((user))
    docker_password : ((password)) # TODO
  
  tasks:
    # - shell: kubectl config view --minify | grep server | cut -f 2- -d ":" | tr -d " "
    #   register: lb_ip
    - name: Install jq
      apt:
        name: jq
        state: present
      become: yes
    - name: "Create Terraform directory"
      file:
        path: /home/eouser/eoepca/terraform
        state: directory
        owner: eouser
        mode: '0755'

    - name: "Transfer global Terraform Infrastructure as Code"
      synchronize:
        src: ../global
        dest: /home/eouser/eoepca/terraform/
        rsync_opts:
          - "--exclude=.terraform"
          - "--exclude=terraform.tfstate*"
    - name: "Transfer test Terraform Infrastructure as Code"
      synchronize:
        src: ../test
        dest: /home/eouser/eoepca/terraform/
        rsync_opts:
          - "--exclude=.terraform"
          - "--exclude=terraform.tfstate*"
    - name: "Terraforming from bastion host"
      shell: |
          terraform init
          terraform apply -auto-approve -var="dh_user_email={{ DOCKER_EMAIL }}" 
                                        -var="dh_user_name={{ DOCKER_USERNAME }}" 
                                        -var="dh_user_password={{ DOCKER_PASSWORD }}" 
                                        -var="hostname=test.eoepca.org"
      args:
        chdir: /home/eouser/eoepca/terraform/test
      register: terraform_result
    # - name: "Terraforming from bastion host"
    #   terraform:
    #     project_path: './eoepca/terraform/test'
    #     variables:
    #       dh_user_email: "{{ DOCKER_EMAIL }}"
    #       dh_user_name: "{{ DOCKER_USERNAME }}"
    #       dh_user_password: "{{ DOCKER_PASSWORD }}"
    #       # nginx_ip: lb_ip.stdout
    #       hostname: "test.eoepca.org"
    #     state: present
    #     force_init: true
    #   register: terraform_result
    
    - name: "Transfer Acceptance testing code"
      copy:
        src: ../../travis/acceptanceTest.sh
        dest: /home/eouser/eoepca/travis/
        owner: eouser
    - name: "Execute acceptance tests"
      shell: sh acceptanceTest.sh
      args:
        chdir: /home/eouser/eoepca/travis
      register: test_result
    - debug: var=test_result.stdout_lines
       
  