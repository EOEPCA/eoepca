apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: data-access
  namespace: rm
spec:
  interval: 5m
  chart:
    spec:
      chart: vs
      version: 2.0.2
      sourceRef:
        kind: HelmRepository
        name: eox-charts
        namespace: rm
  valuesFrom:
  - kind: Secret
    name: cache-access-secret
    valuesKey: values.yaml
  values:
    envVar:
      general:
        REGISTRAR_REPLACE: "true"
        CPL_VSIL_CURL_ALLOWED_EXTENSIONS: .TIF,.tif,.xml,.jp2
      startup_scripts:
        - /registrar_pycsw/registrar_pycsw/initialize-collections.sh
    storage:
      data:
        data:
          type: S3
          endpoint_url: http://data.cloudferro.com
          access_key_id: access
          secret_access_key: access
          region_name: RegionOne
      cache:
        type: S3
        endpoint_url: "https://cf2.cloudferro.com:8080/cache-bucket"
        host: "cf2.cloudferro.com:8080"
        region_name: RegionOne
        bucket: cache-bucket
    serviceMetadata:
      title: EOEPCA Data Access Service developed by EOX
      abstract: EOEPCA Data Access Service developed by EOX
      header: "EOEPCA Data Access View Server (VS) Client powered by <a href=\"//eox.at\"><img src=\"//eox.at/wp-content/uploads/2017/09/EOX_Logo.svg\" alt=\"EOX\" style=\"height:25px;margin-left:10px\"/></a>"
      url: https://ecma/cache/ows
      keyword: view service
      accessConstraints: UNKNOWN
      fees: UNKNOWN
      contactName: Stephan Meissl
      contactPhone: Please contact via mail.
      contactFacsimile: None
      contactOrganization: EOX IT Services GmbH
      contactCity: Vienna
      contactStateOrProvince: Vienna
      contactPostcode: 1090
      contactCountry: Austria
      contactElectronicMailAddress: office@eox.at
      contactPosition: CTO
      providerName: EOX
      providerUrl: https://eox.at
      inspireProfile: true
      inspireMetadataUrl: TBD
      defaultLanguage: eng
      language: eng
    serviceConfig:
      cache:
        wmsEnabled: true
        wmtsEnabled: true
        connectionTimeout: 10
        timeout: 120
        expires: 3600
        key: /{tileset}/{grid}/{dim}/{z}/{x}/{y}.{ext}
      registrar:
        backends:
          - path: registrar_pycsw.backend.PycswBackend
            kwargs:
              repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw
              ows_url: https://data-access.develop.eoepca.org/ows
    dataScheme:
      layers:
        - id: S2L1C
          title: Sentinel-2 Level 1C True Color
          abstract: Sentinel-2 Level 2A True Color
          displayColor: '#eb3700'
          grids:
            - name: WGS84
              zoom: 13
          parentLayer: S2L1C
        - id: S2L1C__TRUE_COLOR
          title: Sentinel-2 Level 1C True Color
          abstract: Sentinel-2 Level 2A True Color
          grids:
            - name: WGS84
              zoom: 13
          parentLayer: S2L1C
        - id: S2L1C__masked_clouds
          title: Sentinel-2 Level 1C True Color with cloud masks
          abstract: Sentinel-2 Level 1C True Color with cloud masks
          grids:
            - name: WGS84
              zoom: 13
          parentLayer: S2L1C
        - id: S2L1C__FALSE_COLOR
          title: Sentinel-2 Level 1C False Color
          abstract: Sentinel-2 Level 1C False Color
          grids:
            - name: WGS84
              zoom: 13
          parentLayer: S2L1C
        - id: S2L1C__NDVI
          title: Sentinel-2 Level 21CNDVI
          abstract: Sentinel-2 Level 1C NDVI
          grids:
            - name: WGS84
              zoom: 13
          parentLayer: S2L1C
        - id: S2L2A
          title: Sentinel-2 Level 2A True Color
          abstract: Sentinel-2 Level 2A True Color
          displayColor: '#eb3700'
          grids:
            - name: WGS84
              zoom: 13
          parentLayer: S2L2A
        - id: S2L2A__TRUE_COLOR
          title: Sentinel-2 Level 2A True Color
          abstract: Sentinel-2 Level 2A True Color
          grids:
            - name: WGS84
              zoom: 13
          parentLayer: S2L2A
        - id: S2L2A__masked_clouds
          title: Sentinel-2 Level 2A True Color with cloud masks
          abstract: Sentinel-2 Level 2A True Color with cloud masks
          grids:
            - name: WGS84
              zoom: 13
          parentLayer: S2L2A
        - id: S2L2A__FALSE_COLOR
          title: Sentinel-2 Level 2A False Color
          abstract: Sentinel-2 Level 2A False Color
          grids:
            - name: WGS84
              zoom: 13
          parentLayer: S2L2A
        - id: S2L2A__NDVI
          title: Sentinel-2 Level 2A NDVI
          abstract: Sentinel-2 Level 2A NDVI
          grids:
            - name: WGS84
              zoom: 13
          parentLayer: S2L2A
      collections:
        S2L1C:
          product_types:
            - S2MSI1C
          coverage_types:
            - S2L1C_B01
            - S2L1C_B02
            - S2L1C_B03
            - S2L1C_B04
            - S2L1C_B05
            - S2L1C_B06
            - S2L1C_B07
            - S2L1C_B08
            - S2L1C_B8A
            - S2L1C_B09
            - S2L1C_B10
            - S2L1C_B11
            - S2L1C_B12
        S2L2A:
          product_types:
            - S2MSI2A
          product_levels:
            - Level-2A
          coverage_types:
            - S2L2A_B01
            - S2L2A_B02
            - S2L2A_B03
            - S2L2A_B04
            - S2L2A_B05
            - S2L2A_B06
            - S2L2A_B07
            - S2L2A_B08
            - S2L2A_B8A
            - S2L2A_B09
            - S2L2A_B11
            - S2L2A_B12
      productTypes:
        - name: S2MSI1C
          filter:
            s2:product_type: S2MSI1C
          metadata_assets: []
          coverages:
            S2L1C_B01:
              assets:
                - B01
            S2L1C_B02:
              assets:
                - B02
            S2L1C_B03:
              assets:
                - B03
            S2L1C_B04:
              assets:
                - B04
            S2L1C_B05:
              assets:
                - B05
            S2L1C_B06:
              assets:
                - B06
            S2L1C_B07:
              assets:
                - B07
            S2L1C_B08:
              assets:
                - B08
            S2L1C_B8A:
              assets:
                - B8A
            S2L1C_B09:
              assets:
                - B09
            S2L1C_B10:
              assets:
                - B10
            S2L1C_B11:
              assets:
                - B11
            S2L1C_B12:
              assets:
                - B12
          defaultBrowse: TRUE_COLOR
          browses:
            TRUE_COLOR:
              asset: visual
              red:
                expression: B04
                range: [0, 4000]
                nodata: 0
              green:
                expression: B03
                range: [0, 4000]
                nodata: 0
              blue:
                expression: B02
                range: [0, 4000]
                nodata: 0
            FALSE_COLOR:
              red:
                expression: B08
                range: [0, 4000]
                nodata: 0
              green:
                expression: B04
                range: [0, 4000]
                nodata: 0
              blue:
                expression: B03
                range: [0, 4000]
                nodata: 0
            NDVI:
              grey:
                expression: (B08-B04)/(B08+B04)
                range: [-1, 1]
          masks:
            clouds:
              validity: false
        - name: S2MSI2A
          filter:
            s2:product_type: S2MSI2A
          metadata_assets: []
          coverages:
            S2L2A_B01:
              assets:
                - B01
            S2L2A_B02:
              assets:
                - B02
            S2L2A_B03:
              assets:
                - B03
            S2L2A_B04:
              assets:
                - B04
            S2L2A_B05:
              assets:
                - B05
            S2L2A_B06:
              assets:
                - B06
            S2L2A_B07:
              assets:
                - B07
            S2L2A_B08:
              assets:
                - B08
            S2L2A_B8A:
              assets:
                - B8A
            S2L2A_B09:
              assets:
                - B09
            S2L2A_B11:
              assets:
                - B11
            S2L2A_B12:
              assets:
                - B12
          default_browse_locator: TCI_10m
          browses:
            TRUE_COLOR:
              asset: visual-10m
              red:
                expression: B04
                range: [0, 4000]
                nodata: 0
              green:
                expression: B03
                range: [0, 4000]
                nodata: 0
              blue:
                expression: B02
                range: [0, 4000]
                nodata: 0
            FALSE_COLOR:
              red:
                expression: B08
                range: [0, 4000]
                nodata: 0
              green:
                expression: B04
                range: [0, 4000]
                nodata: 0
              blue:
                expression: B03
                range: [0, 4000]
                nodata: 0
            NDVI:
              grey:
                expression: (B08-B04)/(B08+B04)
                range: [-1, 1]
          masks:
            clouds:
              validity: false
    database:
      persistence:
        enabled: true
        existingClaim: data-access-db
    redis:
      usePassword: false
      persistence:
        existingClaim: data-access-redis
      master:
        persistence:
          enabled: true
          storageClass: managed-nfs-storage
      cluster:
        enabled: false
    kubeConfig:
      ingress:
        enabled: true
        annotations:
          kubernetes.io/ingress.class: nginx
          kubernetes.io/tls-acme: "true"
          nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
          nginx.ingress.kubernetes.io/enable-cors: "true"
          cert-manager.io/cluster-issuer: letsencrypt
        hosts:
          - host: data-access-open.develop.eoepca.org
        tls:
          - hosts:
              - data-access-open.develop.eoepca.org
            secretName: data-access-open-tls
      registrar:
        image:
          repository: eoepca/rm-data-access-core
          tag: "0.9.7"
          # pullPolicy: Always
      renderer:
        image:
          repository: eoepca/rm-data-access-core
          tag: "0.9.7"
          # pullPolicy: Always
      client:
        image:
          tag: "release-1.5.2"
      cache:
        image:
          tag: "release-1.5.2"
